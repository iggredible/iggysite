<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Start using Promisify to avoid JS callback spaghetti | Hello there.</title>
    <meta name="description" content="Things Iggy writes about">
    
    
    <link rel="preload" href="/assets/css/0.styles.74245eb8.css" as="style"><link rel="preload" href="/assets/js/app.411ac2ac.js" as="script"><link rel="preload" href="/assets/js/2.826a9c57.js" as="script"><link rel="preload" href="/assets/js/16.a4da2abb.js" as="script"><link rel="prefetch" href="/assets/js/10.33a00c4d.js"><link rel="prefetch" href="/assets/js/11.9e2c5904.js"><link rel="prefetch" href="/assets/js/12.82d02492.js"><link rel="prefetch" href="/assets/js/13.2bba91b0.js"><link rel="prefetch" href="/assets/js/14.496d3aa4.js"><link rel="prefetch" href="/assets/js/15.8e326966.js"><link rel="prefetch" href="/assets/js/17.8eec3b06.js"><link rel="prefetch" href="/assets/js/18.edb89630.js"><link rel="prefetch" href="/assets/js/19.4431ab75.js"><link rel="prefetch" href="/assets/js/20.4463634e.js"><link rel="prefetch" href="/assets/js/21.d60a97f5.js"><link rel="prefetch" href="/assets/js/22.443a8923.js"><link rel="prefetch" href="/assets/js/23.cdd341e7.js"><link rel="prefetch" href="/assets/js/3.14889d81.js"><link rel="prefetch" href="/assets/js/4.6512c86b.js"><link rel="prefetch" href="/assets/js/5.839bfab5.js"><link rel="prefetch" href="/assets/js/6.3a95a3b3.js"><link rel="prefetch" href="/assets/js/7.00a5fbce.js"><link rel="prefetch" href="/assets/js/8.27c044bc.js"><link rel="prefetch" href="/assets/js/9.b297b1cf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74245eb8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><header class="px-6 bg-white flex flex-wrap items-center py-8"><input type="checkbox" id="menu-toggle" class="hidden"> <label id="hamburger" for="menu-toggle" class="fixed cursor-pointer block z-20"><div id="burgerToggle" class="cursor-pointer"><span></span> <span></span> <span></span></div></label> <div id="sideMenu" class="bg-gray-800 z-10 fixed top-0 left-0 bottom-0 w-64"><ul class="my-16 mx-4"><li class="my-4 cursor-default hover:no-underline"><div class="container flex flex-col items-start justify-center"><div class="my-4"><img src="/assets/img/iggy_square.57401581.jpg" class="ml-0 h-20 w-20 mb-4 rounded-full"> <div class="font-bold text-white mb-4">Igor Irianto</div> <div class="font-light text-gray-500 text-sm">Frontend dev who likes to post about Vim, JS, and other computer stuff. Lives in Dallas. Married. He doesn't have a lot of twitter follower so you should <a href="https://twitter.com/iggredible">add him</a>.</div></div></div></li> <li class="my-4 text-white font-light"><a href="#">Blogs</a></li> <li class="my-4 text-white font-light"><a href="#">About</a></li></ul></div> <div class="absolute top-0 right-0 m-4"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="container max-w-5xl mx-auto"><!----> <div class="max-w-4xl mx-auto"><div class="relative"><div class="fixed top-4 left-0 pl-5"><a href="/">Home</a></div> <div class="content mx-16 lg:mx-24"><h1 class="text-center">Start using Promisify to avoid JS callback spaghetti</h1> <h6 class="text-center italic font-light m-4">Use promisify to avoid JS callback spaghetti</h6> <h4></h4> <div class="content__default"><p>Asynchronous codes are common in JS programming, like fetching data from an endpoint and reading dir/files. Often they require us to pass a <em>callback</em> function that will be executed when the action is completed.</p> <h1 id="the-problem-with-callback-async"><a href="#the-problem-with-callback-async" aria-hidden="true" class="header-anchor">#</a> The problem with callback async</h1> <p>The problem with callback async is that they can get messy.</p> <p>If I want to read a file (using <a href="https://nodejs.org/api/fs.html#fs_fs_readfile_path_options_callback" target="_blank" rel="noopener noreferrer">fs.readFile<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>), I can do it like this:</p> <div class="language- extra-class"><pre class="language-text"><code>fs.readFile('./file/location.md', 'utf-8', function(err, val){
  if(err) throw new Error (&quot;Something terrible happened&quot;)
  console.log(&quot;Content: &quot;, val)
})
console.log(&quot;Waiting...&quot;)
</code></pre></div><p>You'll notice <code>&quot;Waiting&quot;</code> is displayed before <code>&quot;Content&quot;</code>. This is because JS automatically moves <strong>all</strong> async functions at the back of the line (regardless how &quot;fast&quot; they execute).</p> <p>Now this is a big deal if we need to use the result of that async function for our next action. If we need to use the result of our callback function, the following won't work:</p> <div class="language- extra-class"><pre class="language-text"><code>let pathToNextLocation; 
fs.readFile('./file/location1.md', 'utf-8', function(err, val){
  if(err) throw new Error
  pathToNextLocation = val; 
})

console.log(pathToNextLocation); 
</code></pre></div><p>We will need to do this instead:</p> <div class="language- extra-class"><pre class="language-text"><code>let pathToNextLocation
fs.readFile('./file/location1.md', 'utf-8', function(err, val){
  if(err) throw new Error
  pathToNextLocation = val; 
  fs.readFile(pathToNextLocation, 'utf-8', function(err, val) {
    // do stuff!
  })
})
</code></pre></div><p>What if we need to execute four async functions in sequence? We would have to nest it four levels deep. This is one big spaghetti.</p> <p><img src="https://media.giphy.com/media/r9jG5FH7chblC/giphy.gif" alt="big spaghetti"></p> <h1 id="better-way-to-handle-async-promises"><a href="#better-way-to-handle-async-promises" aria-hidden="true" class="header-anchor">#</a> Better way to handle async: Promises</h1> <p>A better way to deal with async function is to use promises. Promises, like callbacks, are asynchronous. Unlike callbacks, they can be chained.</p> <p>Promise takes 2 arguments and we need to <code>resolve</code> it - think of it like Promise's own way to return value when it is done.</p> <div class="language- extra-class"><pre class="language-text"><code>new Promise((resolve, reject) =&gt;
  resolve('Hello promise')
)
.then(value =&gt; console.log(value))
</code></pre></div><p>This <code>then</code> chain is really awesome, because now we can do something like this:</p> <div class="language- extra-class"><pre class="language-text"><code>asyncReadFile('./file/to/location1.md', 'utf-8')
.then(value =&gt; {
  return anotherPromise
})
.then(value =&gt; {
  return anotherPromise
})
.then(value =&gt; {
  return yetAnotherPromise
})
// and so on
</code></pre></div><p>This looks MUCH better than callback spaghetti.</p> <h1 id="putting-the-two-together-replace-all-callbacks-with-promises"><a href="#putting-the-two-together-replace-all-callbacks-with-promises" aria-hidden="true" class="header-anchor">#</a> Putting the two together: replace all callbacks with promises</h1> <p>We learned two things:</p> <ol><li>Too many callbacks leads to spaghetti code</li> <li>Chained promises are easy to read</li></ol> <p>However, callbacks functions are not the same thing as promises. <code>fs.readFile</code> do not return promises. We can't just use <code>then</code> chain on several <code>fs.readFile</code> together.</p> <blockquote><p>&quot;Hmm, I wonder if there is a way to convert them callbacks into promises so I can chain them and make them look pretty?&quot; - me thinking</p></blockquote> <p>Absolutely!! <a href="https://nodejs.org/dist/latest-v8.x/docs/api/util.html#util_util_promisify_original" target="_blank" rel="noopener noreferrer">Promisify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> does JUST that.</p> <p>Promisify is part of util built into Node 8+. It accepts a function that accepts a callback function (wow, that's a mouthful). The resulting function is a function that returns a promise. Let's jump straight into it. It will make sense after we run it ourselves.</p> <p>Let's create several files in a directory that contains the name of other files to read. Then we will read the first file - see if we can make it to the last file.</p> <div class="language- extra-class"><pre class="language-text"><code>// file1.md
file2.md

// file2.md
file3.md

// file3.md
Finished!

// reader.js
const fs = require(&quot;fs&quot;);
const { promisify } = require(&quot;util&quot;);

const promiseReadFile = promisify(fs.readFile);

promiseReadFile(&quot;file1.md&quot;, &quot;utf-8&quot;)
  .then(content =&gt; {
    const nextFileToRead = content.trim();
    return promiseReadFile(nextFileToRead, &quot;utf-8&quot;);
  })
  .then(content =&gt; {
    const nextFileToRead = content.trim();
    return promiseReadFile(nextFileToRead, &quot;utf-8&quot;);
  })
  .then(content =&gt; {
    console.log(content.trim());
  });
</code></pre></div><p>Now let's <code>node ./reader.js</code> and see what happens. You should see <code>&quot;Finished!&quot;</code> printed.</p> <p>Sweet! Now that is one spaghetti I don't mind eating.</p> <p><img src="https://media.giphy.com/media/3o72F2CaK3Hk53WxGg/giphy.gif" alt="delicious spaghetti"></p> <p>Javascript has another way to handle promises: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank" rel="noopener noreferrer">async/await<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>To test your understanding, can you convert promisified code above from <code>then</code> into <code>async/await</code>?</p> <p>Thanks for reading. Happy hackin'! Let me know if you have questions!</p> <h1 id="resources"><a href="#resources" aria-hidden="true" class="header-anchor">#</a> Resources</h1> <ol><li><a href="https://2ality.com/2017/05/util-promisify.html" target="_blank" rel="noopener noreferrer">util promisify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/greyatom/node8s-util-promisify-is-so-awesome-9819f1b56d18" target="_blank" rel="noopener noreferrer">node8 util promisify is so awesome<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://javascript.info/promisify" target="_blank" rel="noopener noreferrer">Promisification<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/trabe/understanding-nodes-promisify-and-callbackify-d2b04efde0e0" target="_blank" rel="noopener noreferrer">understanding nodes promisify and callbackify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener noreferrer">Promise docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://dev.to/martinnrdstrm/callback-functions-innodejs--2607" target="_blank" rel="noopener noreferrer">callback functions in nodeJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://levelup.gitconnected.com/javascript-and-asynchronous-magic-bee537edc2da" target="_blank" rel="noopener noreferrer">Javascript and asynchronous magic<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/better-programming/is-javascript-synchronous-or-asynchronous-what-the-hell-is-a-promise-7aa9dd8f3bfb" target="_blank" rel="noopener noreferrer">Is JavaScript Synchronous or Asynchronous? What the Hell is a Promise?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div></div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.411ac2ac.js" defer></script><script src="/assets/js/2.826a9c57.js" defer></script><script src="/assets/js/16.a4da2abb.js" defer></script>
  </body>
</html>
